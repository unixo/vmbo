<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>vmbo - Virtual Memory BO:  File sorgente vmbo/src/mmu.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generato da Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Pagina&nbsp;Principale</span></a></li>
      <li><a href="modules.html"><span>Moduli</span></a></li>
      <li><a href="annotated.html"><span>Strutture&nbsp;dati</span></a></li>
      <li class="current"><a href="files.html"><span>File</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>Elenco&nbsp;dei&nbsp;file</span></a></li>
      <li><a href="globals.html"><span>Elementi&nbsp;globali</span></a></li>
    </ul>
  </div>
<h1>vmbo/src/mmu.c</h1><a href="a00017.html">Vai alla documentazione di questo file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="a00018.html">mmu.h</a>"</span>
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="a00017.html#2b7cf2a3641be7b89138615764d60ba3">00015</a> <span class="preprocessor">#define EMPTY               0</span>
<a name="l00016"></a><a class="code" href="a00017.html#361f5c696ea1c92c5f6bcc10579dc71c">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define DATA_AVAILABLE      1</span>
<a name="l00017"></a><a class="code" href="a00017.html#d5bf9f19224fe7d09c85b593d5e25b42">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define RESULT_AVAILABLE    2</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="a00025.html#e4cc024f7d0cb7543216fc463ab91af3">00024</a> <span class="keywordtype">int</span> <a class="code" href="a00017.html#e4cc024f7d0cb7543216fc463ab91af3" title="Indica se la paginazione anticipata risulta attiva.">anticipatory_paging</a>;
<a name="l00025"></a>00025 
<a name="l00034"></a><a class="code" href="a00009.html">00034</a> <span class="keyword">struct </span><a class="code" href="a00009.html" title="Struttura per contenere la richiesta attuale alla MMU.">mmu_shared_data</a> {
<a name="l00036"></a><a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">00036</a>     <span class="keywordtype">int</span> <a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>;
<a name="l00038"></a><a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">00038</a>     <a class="code" href="a00024.html#6593e0188f8e2719be63f87d53734582" title="Definizione del tipo numero intero non segnato a 32 bit.">uint32_t</a> <a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">virtual_address</a>;
<a name="l00040"></a><a class="code" href="a00009.html#cb9f48647496bd11e112f404238dc138">00040</a>     <a class="code" href="a00024.html#6593e0188f8e2719be63f87d53734582" title="Definizione del tipo numero intero non segnato a 32 bit.">uint32_t</a> <a class="code" href="a00009.html#cb9f48647496bd11e112f404238dc138">translated_address</a>;
<a name="l00042"></a><a class="code" href="a00009.html#46d8fecc4efcd342f94ef379799fd7db">00042</a>     <span class="keywordtype">int</span> <a class="code" href="a00009.html#46d8fecc4efcd342f94ef379799fd7db">rw</a>;
<a name="l00044"></a><a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">00044</a>     <span class="keywordtype">int</span> <a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">status</a>;
<a name="l00046"></a><a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">00046</a>     pthread_mutex_t <a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>;
<a name="l00048"></a><a class="code" href="a00009.html#2d017047068ee847b500c14427ac4d6b">00048</a>     pthread_cond_t <a class="code" href="a00009.html#2d017047068ee847b500c14427ac4d6b">condition</a>;
<a name="l00049"></a>00049 } <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a> = 
<a name="l00050"></a>00050        { -1, 0, 0, 0, 0, PTHREAD_MUTEX_INITIALIZER, PTHREAD_COND_INITIALIZER };
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00060"></a><a class="code" href="a00017.html#c7cb312ff21e1988a8b6bcd47f7449a5">00060</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="a00017.html#c7cb312ff21e1988a8b6bcd47f7449a5" title="Variabile di controllo per l&amp;#39;MMU.">mmu_should_exit</a>;
<a name="l00061"></a>00061 
<a name="l00065"></a><a class="code" href="a00017.html#66b87664ca0ad1edc381b14015d44eb5">00065</a> <span class="keyword">static</span> pthread_mutex_t <a class="code" href="a00017.html#66b87664ca0ad1edc381b14015d44eb5" title="Mutex per la mutua esclusione della chiamata a memory_access.">mem_read_lock</a> = PTHREAD_MUTEX_INITIALIZER;
<a name="l00066"></a>00066 
<a name="l00070"></a><a class="code" href="a00004.html#339066f0a9dda46677ff2b1995798f54">00070</a> <span class="keyword">static</span> <a class="code" href="a00021.html#7b54f0de61925e7cf33184c2ec24da14">STAILQ_HEAD</a>(<a class="code" href="a00004.html">free_frames</a>, <a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame</a>) <a class="code" href="a00017.html#004c64e9f470ff8317d439639f332c6e" title="Lista dei frame inutilizzati (puntatore al primo elemento).">free_frames_head</a>;
<a name="l00071"></a>00071 
<a name="l00075"></a><a class="code" href="a00014.html#339066f0a9dda46677ff2b1995798f54">00075</a> static <a class="code" href="a00021.html#7b54f0de61925e7cf33184c2ec24da14">STAILQ_HEAD</a>(<a class="code" href="a00014.html">used_frames</a>, <a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame</a>) <a class="code" href="a00017.html#a7a68db730586e1b608240a228d4f707" title="Lista dei frame utilizzati (puntatore al primo elemento).">used_frames_head</a>;
<a name="l00076"></a>00076 
<a name="l00081"></a><a class="code" href="a00002.html#03f9f7426c4353aa705e6a69b7e1143d">00081</a> static <a class="code" href="a00021.html#4abce769a262e090c1f601605b9d6c76">TAILQ_HEAD</a>(<a class="code" href="a00002.html">active_pages</a>, <a class="code" href="a00001.html" title="Struttura per rappresentare una pagina associata ad un frame.">active_page</a>) <a class="code" href="a00017.html#16e8bd7a2c1c586be688cd20715372ca">active_page_head</a>;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 extern <a class="code" href="a00012.html" title="Struttura per la rappresentazione in memoria di un processo.">proc_t</a> **<a class="code" href="a00015.html#9399ea5dcc68d7ce40f84bf37593a936" title="Vettore dei processi attivi.">proc_table</a>;
<a name="l00084"></a>00084 extern <span class="keywordtype">int</span> <a class="code" href="a00015.html#710037465055a75cba7d3b2625f966f8" title="Numero di processi concorrenti.">max_proc</a>;
<a name="l00085"></a>00085 extern <span class="keywordtype">int</span> <a class="code" href="a00017.html#c3e1795766a80ec63b157951b4b9a7d4" title="Livello di debug.">debug</a>;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 
<a name="l00103"></a>00103 static <span class="keywordtype">int</span>
<a name="l00104"></a><a class="code" href="a00028.html#gbdc6ce22565ec4cc97a358429ffa5bd4">00104</a> <a class="code" href="a00028.html#gbdc6ce22565ec4cc97a358429ffa5bd4" title="Algoritmo di rimpiazzo della pagina.">second_chance</a>(<span class="keywordtype">int</span> procnum, <a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a> <a class="code" href="a00011.html" title="Struttura per la rappresentazione di una pagina virtuale.">page</a>, <span class="keywordtype">int</span> update_stats, <a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame_t</a> **<a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame</a>)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <a class="code" href="a00001.html" title="Struttura per rappresentare una pagina associata ad un frame.">active_page_t</a> *ap;
<a name="l00107"></a>00107     <a class="code" href="a00012.html" title="Struttura per la rappresentazione in memoria di un processo.">proc_t</a> *current_proc;
<a name="l00108"></a>00108     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frame_id;
<a name="l00109"></a>00109     <span class="keywordtype">int</span> result;
<a name="l00110"></a>00110     <a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame_t</a> *f;
<a name="l00111"></a>00111     
<a name="l00112"></a>00112     current_proc = proc_table[procnum];
<a name="l00113"></a>00113     f = NULL;
<a name="l00114"></a>00114     
<a name="l00115"></a>00115     <span class="comment">/* </span>
<a name="l00116"></a>00116 <span class="comment">     *  Verifico se la pagina richiesta e' presente, ovvero se risulta gia'</span>
<a name="l00117"></a>00117 <span class="comment">     *  associata ad un frame fisico.</span>
<a name="l00118"></a>00118 <span class="comment">     */</span>
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (<a class="code" href="a00018.html#ad7eab9aa3f866ff597b8afef4ee4e7f" title="Restituisce 1 se la pagina e&amp;#39; presente in memoria.">IS_PAGE_PRESENT</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page])) {
<a name="l00120"></a>00120         <span class="comment">/*</span>
<a name="l00121"></a>00121 <span class="comment">         *  La pagina e' presente: incremento la statistica degli HIT,</span>
<a name="l00122"></a>00122 <span class="comment">         *  ottengo l'ID del frame associato e lo cerco all'interno della</span>
<a name="l00123"></a>00123 <span class="comment">         *  lista dei frame utilizzati: una volta trovato, imposto ad uno</span>
<a name="l00124"></a>00124 <span class="comment">         *  il bit Reference.</span>
<a name="l00125"></a>00125 <span class="comment">         */</span>
<a name="l00126"></a>00126         frame_id = <a class="code" href="a00018.html#c08bbc74a539602f7b54686146d2aa4b" title="Restituisce il frame-id della pgina.">FRAME_ID</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page]);
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (update_stats)
<a name="l00128"></a>00128             <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#259b2896187acb71444706a1878157e4">page_hits</a>++;
<a name="l00129"></a>00129         result = 1;
<a name="l00130"></a>00130         
<a name="l00131"></a>00131         <a class="code" href="a00021.html#77999ebdf5aaf7af8b8ea22bf208c432">STAILQ_FOREACH</a>(f, &amp;used_frames_head, entries) {
<a name="l00132"></a>00132             <span class="keywordflow">if</span> (frame_id == f-&gt;<a class="code" href="a00003.html#4fc3a0c58dfbd1e68224521185cb9384">id</a>) {
<a name="l00133"></a>00133                 <a class="code" href="a00018.html#c3fa31a10f3114cc8ca1eb8138fb0ff9" title="Imposta ad uno il bit reference della pagina.">PAGE_SET_REFERENCED</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page]);
<a name="l00134"></a>00134                 <span class="keywordflow">break</span>;
<a name="l00135"></a>00135             }
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137 <span class="preprocessor">#ifdef VM_DEBUG</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>        assert(frame_id == f-&gt;<a class="code" href="a00003.html#4fc3a0c58dfbd1e68224521185cb9384">id</a>);
<a name="l00139"></a>00139 <span class="preprocessor">#endif </span><span class="comment">/* VM_DEBUG */</span>
<a name="l00140"></a>00140     } <span class="keywordflow">else</span> {
<a name="l00141"></a>00141         <span class="comment">/*</span>
<a name="l00142"></a>00142 <span class="comment">         *  La pagina richiesta non e' presente in memoria. Aggiorno il</span>
<a name="l00143"></a>00143 <span class="comment">         *  contatore dei FAULT e verifico se:</span>
<a name="l00144"></a>00144 <span class="comment">         *    1. sono disponibili dei frame non ancora utilizzati</span>
<a name="l00145"></a>00145 <span class="comment">         *    2. viceversa, devo individuare quale frame liberare.</span>
<a name="l00146"></a>00146 <span class="comment">         */</span>
<a name="l00147"></a>00147         result = 0;
<a name="l00148"></a>00148         <span class="keywordflow">if</span> (update_stats) {
<a name="l00149"></a>00149             <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#e050b82b994239e7902e82bb0ce27626">page_faults</a>++;
<a name="l00150"></a>00150             current_proc-&gt;<a class="code" href="a00012.html#b30a97b34de52ba50f4a68dd215fe39a">stats</a>.<a class="code" href="a00013.html#1bce99c82d1ae9585d492e4c27576d8c">page_faults</a>++;
<a name="l00151"></a>00151         } 
<a name="l00152"></a>00152         
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (<a class="code" href="a00021.html#8427c8f43d09d73062cf6b37f303aff5">STAILQ_EMPTY</a>(&amp;free_frames_head)) {
<a name="l00154"></a>00154             <span class="comment">/*</span>
<a name="l00155"></a>00155 <span class="comment">             *  La lista dei frame liberi e' vuota: applico l'algoritmo</span>
<a name="l00156"></a>00156 <span class="comment">             *  "enhanced second chance"</span>
<a name="l00157"></a>00157 <span class="comment">             */</span>
<a name="l00158"></a>00158             <span class="keywordtype">int</span> proc_found, page_found;
<a name="l00159"></a>00159             
<a name="l00160"></a>00160             page_found = proc_found = -1;
<a name="l00161"></a>00161             
<a name="l00162"></a>00162             <span class="comment">/*</span>
<a name="l00163"></a>00163 <span class="comment">             *  Inizio a scorrere la lista delle pagine associate a frame,</span>
<a name="l00164"></a>00164 <span class="comment">             *  alla ricerca di una pagina con i bit R e D posti a zero; se</span>
<a name="l00165"></a>00165 <span class="comment">             *  trovo una pagina con il bit D uguale ad uno, ne effettuo</span>
<a name="l00166"></a>00166 <span class="comment">             *  una copia su disco (write back) e pongo il bit a zero; se</span>
<a name="l00167"></a>00167 <span class="comment">             *  trovo una pagina con il bit R uguale ad uno, lo pongo uguale</span>
<a name="l00168"></a>00168 <span class="comment">             *  a zero e continuo la ricerca.</span>
<a name="l00169"></a>00169 <span class="comment">             */</span>
<a name="l00170"></a>00170             <span class="keywordflow">while</span> (page_found == -1) {
<a name="l00171"></a>00171                 <a class="code" href="a00021.html#16e5fc168e7f3494d4b1df54447d871e">TAILQ_FOREACH</a>(ap, &amp;active_page_head, entries) {
<a name="l00172"></a>00172                     <span class="keywordflow">if</span> (<a class="code" href="a00018.html#6011943db531bd72ddd4dc11ba079ff8" title="Restituisce 1 se la pagina e&amp;#39; &amp;quot;sporca&amp;quot;.">IS_PAGE_DIRTY</a>(proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;page_table[ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>])) {
<a name="l00173"></a>00173                         fprintf(proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;log_file,
<a name="l00174"></a>00174                                 <span class="stringliteral">"Write-back della pagina %d\n"</span>, ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>);
<a name="l00175"></a>00175                         <a class="code" href="a00018.html#0439c9d8b12a7ca812625cbe25cf6452" title="Imposta a zero il bit dirty della pagina.">PAGE_CLEAR_DIRTY</a>(proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;page_table[ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>]);
<a name="l00176"></a>00176                         <a class="code" href="a00018.html#25b47a83e026f74189671b7264235bf4" title="Imposta a zero il bit reference della pagina.">PAGE_CLEAR_REFERENCED</a>(proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;page_table[ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>]);
<a name="l00177"></a>00177                         <span class="keywordflow">continue</span>;
<a name="l00178"></a>00178                     }
<a name="l00179"></a>00179                     <span class="keywordflow">if</span> (!<a class="code" href="a00018.html#7a22e161e9dc14ba9e29a1a141995fd2" title="Restituisce 1 se la pagina e&amp;#39; stata referenziata.">IS_PAGE_REFERENCED</a>(proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;page_table[ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>])
<a name="l00180"></a>00180                         &amp;&amp; !<a class="code" href="a00018.html#6011943db531bd72ddd4dc11ba079ff8" title="Restituisce 1 se la pagina e&amp;#39; &amp;quot;sporca&amp;quot;.">IS_PAGE_DIRTY</a>(proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;page_table[ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>])) {
<a name="l00181"></a>00181                         proc_found = ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>;
<a name="l00182"></a>00182                         page_found = ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>;
<a name="l00183"></a>00183                         <span class="keywordflow">break</span>;
<a name="l00184"></a>00184                     } <span class="keywordflow">else</span> {
<a name="l00185"></a>00185                         <span class="keywordflow">if</span> (<a class="code" href="a00018.html#7a22e161e9dc14ba9e29a1a141995fd2" title="Restituisce 1 se la pagina e&amp;#39; stata referenziata.">IS_PAGE_REFERENCED</a>
<a name="l00186"></a>00186                             (proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;page_table
<a name="l00187"></a>00187                              [ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>])) {
<a name="l00188"></a>00188                             <a class="code" href="a00018.html#25b47a83e026f74189671b7264235bf4" title="Imposta a zero il bit reference della pagina.">PAGE_CLEAR_REFERENCED</a>(proc_table[ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a>]-&gt;page_table[ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a>]);
<a name="l00189"></a>00189                             <span class="keywordflow">continue</span>;
<a name="l00190"></a>00190                         }
<a name="l00191"></a>00191                     }
<a name="l00192"></a>00192                 }
<a name="l00193"></a>00193             }
<a name="l00194"></a>00194             
<a name="l00195"></a>00195 <span class="preprocessor">#ifdef VM_DEBUG</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span>            assert(<a class="code" href="a00018.html#7a22e161e9dc14ba9e29a1a141995fd2" title="Restituisce 1 se la pagina e&amp;#39; stata referenziata.">IS_PAGE_REFERENCED</a>(proc_table[proc_found]-&gt;page_table[page_found]) == 0);
<a name="l00197"></a>00197             assert(<a class="code" href="a00018.html#6011943db531bd72ddd4dc11ba079ff8" title="Restituisce 1 se la pagina e&amp;#39; &amp;quot;sporca&amp;quot;.">IS_PAGE_DIRTY</a>(proc_table[proc_found]-&gt;page_table[page_found]) == 0);
<a name="l00198"></a>00198 <span class="preprocessor">#endif </span><span class="comment">/* VM_DEBUG */</span>
<a name="l00199"></a>00199             
<a name="l00200"></a>00200             <span class="comment">/*</span>
<a name="l00201"></a>00201 <span class="comment">             *  E' stata identificato il processo che possiede la pagina da</span>
<a name="l00202"></a>00202 <span class="comment">             *  rimuovere dalla memoria: ne estraggo il frame ID.</span>
<a name="l00203"></a>00203 <span class="comment">             */</span>
<a name="l00204"></a>00204             frame_id = <a class="code" href="a00018.html#c08bbc74a539602f7b54686146d2aa4b" title="Restituisce il frame-id della pgina.">FRAME_ID</a>(proc_table[proc_found]-&gt;page_table[page_found]);
<a name="l00205"></a>00205             
<a name="l00206"></a>00206             <span class="comment">/*</span>
<a name="l00207"></a>00207 <span class="comment">             *  Elimino l'associazione tra la pagina identificata ed il </span>
<a name="l00208"></a>00208 <span class="comment">             *  frame associato: questo implica porre uguale a zero anche i</span>
<a name="l00209"></a>00209 <span class="comment">             *  bit R e D, nonche' rimuoverlo dalla lista active_pages.</span>
<a name="l00210"></a>00210 <span class="comment">             */</span>
<a name="l00211"></a>00211             fprintf(current_proc-&gt;<a class="code" href="a00012.html#b936051f5aaca44c6c3c41dee0d19c36">log_file</a>,
<a name="l00212"></a>00212                     <span class="stringliteral">"&lt;-- La pagina %d del processo %d e stata rimossa "</span>
<a name="l00213"></a>00213                     <span class="stringliteral">"dalla memoria %s(frame %d)\n"</span>, page_found, proc_found,
<a name="l00214"></a>00214                     (<a class="code" href="a00018.html#6011943db531bd72ddd4dc11ba079ff8" title="Restituisce 1 se la pagina e&amp;#39; &amp;quot;sporca&amp;quot;.">IS_PAGE_DIRTY</a>(proc_table[proc_found]-&gt;page_table[page_found]) ?
<a name="l00215"></a>00215                      <span class="stringliteral">"e paginata su disco "</span> : <span class="stringliteral">""</span>),
<a name="l00216"></a>00216                     <a class="code" href="a00018.html#c08bbc74a539602f7b54686146d2aa4b" title="Restituisce il frame-id della pgina.">FRAME_ID</a>(proc_table[proc_found]-&gt;page_table[page_found]));
<a name="l00217"></a>00217             
<a name="l00218"></a>00218             <a class="code" href="a00018.html#66ac1d700e6118f81a99a61098b9f2fa" title="Imposta a zero il bit present della pagina.">PAGE_CLEAR_PRESENT</a>(proc_table[proc_found]-&gt;page_table[page_found]);
<a name="l00219"></a>00219             <a class="code" href="a00018.html#25b47a83e026f74189671b7264235bf4" title="Imposta a zero il bit reference della pagina.">PAGE_CLEAR_REFERENCED</a>(proc_table[proc_found]-&gt;page_table[page_found]);
<a name="l00220"></a>00220             <a class="code" href="a00018.html#0439c9d8b12a7ca812625cbe25cf6452" title="Imposta a zero il bit dirty della pagina.">PAGE_CLEAR_DIRTY</a>(proc_table[proc_found]-&gt;page_table[page_found]);
<a name="l00221"></a>00221             <a class="code" href="a00018.html#cd587464f41f54435687db81d3458993" title="Imposta a zero il frame-id della pagina.">PAGE_CLEAR_FRAMEID</a>(proc_table[proc_found]-&gt;page_table[page_found]);
<a name="l00222"></a>00222             
<a name="l00223"></a>00223             <a class="code" href="a00021.html#aae87ca18c28066e1a96221e762d1209">TAILQ_REMOVE</a>(&amp;active_page_head, ap, entries);
<a name="l00224"></a>00224             <a class="code" href="a00024.html#26b1ec19cda38557779b21ff0b1a7d65" title="Deallocazione sicura di un blocco di memoria. Viene dapprima effettuato un controllo...">XFREE</a>(ap);
<a name="l00225"></a>00225             
<a name="l00226"></a>00226             <span class="comment">/* </span>
<a name="l00227"></a>00227 <span class="comment">             *  Tramite il frame ID ottenuto in precedenza, cerco il frame </span>
<a name="l00228"></a>00228 <span class="comment">             *  nella lista used_frames per associarvi la nuova pagina;</span>
<a name="l00229"></a>00229 <span class="comment">             *  analogamente inserisco una nuova voce nella lista </span>
<a name="l00230"></a>00230 <span class="comment">             *  active_pages.</span>
<a name="l00231"></a>00231 <span class="comment">             */</span>
<a name="l00232"></a>00232             <a class="code" href="a00021.html#77999ebdf5aaf7af8b8ea22bf208c432">STAILQ_FOREACH</a>(f, &amp;used_frames_head, entries) {
<a name="l00233"></a>00233                 <span class="keywordflow">if</span> (frame_id == f-&gt;<a class="code" href="a00003.html#4fc3a0c58dfbd1e68224521185cb9384">id</a>) {
<a name="l00234"></a>00234                     <a class="code" href="a00018.html#c3fa31a10f3114cc8ca1eb8138fb0ff9" title="Imposta ad uno il bit reference della pagina.">PAGE_SET_REFERENCED</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page]);
<a name="l00235"></a>00235                     <a class="code" href="a00018.html#a4fd9819f686e5a32f5223c7ac941bcb" title="Imposta ad uno il bit present della pagina.">PAGE_SET_PRESENT</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page]);
<a name="l00236"></a>00236                     <a class="code" href="a00018.html#29b3192fe6429305beb4fb4a2366b213" title="Imposta il frame-id per la pagina &amp;quot;p&amp;quot;.">PAGE_SET_FRAMEID</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page], frame_id);
<a name="l00237"></a>00237                     <a class="code" href="a00018.html#6450fa975b25a17fa02ee10dc22c0c0c" title="Assegna il frame &amp;quot;f&amp;quot; alla pagina &amp;quot;n&amp;quot; del processo &amp;quot;p&amp;quot;...">ASSIGN_FRAME_TO_PROC</a>(f, current_proc, page);
<a name="l00238"></a>00238                     <a class="code" href="a00021.html#2a0d6665f277f80bf301a16e6ab2403c">STAILQ_REMOVE</a>(&amp;used_frames_head, f, frame, entries);
<a name="l00239"></a>00239                     <a class="code" href="a00021.html#7bc9a31418b55c5698be3e54e10bb484">STAILQ_INSERT_TAIL</a>(&amp;used_frames_head, f, entries);
<a name="l00240"></a>00240                     
<a name="l00241"></a>00241                     ap = <a class="code" href="a00024.html#5bd6c80bbb0fa36b35dddb1c9606e99c" title="Macro per migliorare la leggibilita&amp;#39; dell&amp;#39;operazione di allocazione di blocchi...">XMALLOC</a>(<a class="code" href="a00001.html" title="Struttura per rappresentare una pagina associata ad un frame.">active_page_t</a>, 1);
<a name="l00242"></a>00242                     ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a> = <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>;
<a name="l00243"></a>00243                     ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a> = page;
<a name="l00244"></a>00244                     <a class="code" href="a00021.html#512bee16b46f601078c96c776d2648c3">TAILQ_INSERT_TAIL</a>(&amp;active_page_head, ap, entries);
<a name="l00245"></a>00245                     
<a name="l00246"></a>00246                     fprintf(current_proc-&gt;<a class="code" href="a00012.html#b936051f5aaca44c6c3c41dee0d19c36">log_file</a>,
<a name="l00247"></a>00247                             <span class="stringliteral">"--&gt; La pagina virtuale %d e' stata "</span>
<a name="l00248"></a>00248                             <span class="stringliteral">"associata al frame %u\n"</span>, page, f-&gt;<a class="code" href="a00003.html#4fc3a0c58dfbd1e68224521185cb9384">id</a>);
<a name="l00249"></a>00249                     <span class="keywordflow">break</span>;
<a name="l00250"></a>00250                 }
<a name="l00251"></a>00251             }
<a name="l00252"></a>00252         } <span class="keywordflow">else</span> {
<a name="l00253"></a>00253             <span class="comment">/*</span>
<a name="l00254"></a>00254 <span class="comment">             *  La pagina richiesta non e' presente (page fault) ma la lista</span>
<a name="l00255"></a>00255 <span class="comment">             *  dei frame liberi non e' vuota: prendo il primo frame</span>
<a name="l00256"></a>00256 <span class="comment">             *  disponibile e lo associo alla pagina.</span>
<a name="l00257"></a>00257 <span class="comment">             */</span>
<a name="l00258"></a>00258             f = <a class="code" href="a00021.html#3e2eb7535019a2829399b24744dd1a66">STAILQ_FIRST</a>(&amp;free_frames_head);
<a name="l00259"></a>00259             <a class="code" href="a00021.html#24c16c7c5c9908022bad7a98ddac9740">STAILQ_REMOVE_HEAD</a>(&amp;free_frames_head, entries);
<a name="l00260"></a>00260             assert(f-&gt;<a class="code" href="a00003.html#4a32eceb12f1d4b807a007461348ec09">valid</a> == 0);
<a name="l00261"></a>00261             f-&gt;<a class="code" href="a00003.html#4a32eceb12f1d4b807a007461348ec09">valid</a> = 1;
<a name="l00262"></a>00262             <a class="code" href="a00018.html#6450fa975b25a17fa02ee10dc22c0c0c" title="Assegna il frame &amp;quot;f&amp;quot; alla pagina &amp;quot;n&amp;quot; del processo &amp;quot;p&amp;quot;...">ASSIGN_FRAME_TO_PROC</a>(f, current_proc, page);
<a name="l00263"></a>00263             <a class="code" href="a00021.html#7bc9a31418b55c5698be3e54e10bb484">STAILQ_INSERT_TAIL</a>(&amp;used_frames_head, f, entries);
<a name="l00264"></a>00264             
<a name="l00265"></a>00265             fprintf(current_proc-&gt;<a class="code" href="a00012.html#b936051f5aaca44c6c3c41dee0d19c36">log_file</a>,
<a name="l00266"></a>00266                     <span class="stringliteral">"--&gt; La pagina virtuale %d e' stata associata al frame %u\n"</span>, 
<a name="l00267"></a>00267                     page, f-&gt;<a class="code" href="a00003.html#4fc3a0c58dfbd1e68224521185cb9384">id</a>);
<a name="l00268"></a>00268             
<a name="l00269"></a>00269             <a class="code" href="a00018.html#a4fd9819f686e5a32f5223c7ac941bcb" title="Imposta ad uno il bit present della pagina.">PAGE_SET_PRESENT</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page]);
<a name="l00270"></a>00270             <a class="code" href="a00018.html#c3fa31a10f3114cc8ca1eb8138fb0ff9" title="Imposta ad uno il bit reference della pagina.">PAGE_SET_REFERENCED</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page]);
<a name="l00271"></a>00271             <a class="code" href="a00018.html#29b3192fe6429305beb4fb4a2366b213" title="Imposta il frame-id per la pagina &amp;quot;p&amp;quot;.">PAGE_SET_FRAMEID</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page], f-&gt;<a class="code" href="a00003.html#4fc3a0c58dfbd1e68224521185cb9384">id</a>);
<a name="l00272"></a>00272             
<a name="l00273"></a>00273             ap = <a class="code" href="a00024.html#5bd6c80bbb0fa36b35dddb1c9606e99c" title="Macro per migliorare la leggibilita&amp;#39; dell&amp;#39;operazione di allocazione di blocchi...">XMALLOC</a>(<a class="code" href="a00001.html" title="Struttura per rappresentare una pagina associata ad un frame.">active_page_t</a>, 1);
<a name="l00274"></a>00274             ap-&gt;<a class="code" href="a00001.html#2ff0507ae66e3e57f919445037f8db1d">procnum</a> = <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>;
<a name="l00275"></a>00275             ap-&gt;<a class="code" href="a00001.html#50d22eccd6a329903c047ce9a7e020ae">page_id</a> = page;
<a name="l00276"></a>00276             <a class="code" href="a00021.html#512bee16b46f601078c96c776d2648c3">TAILQ_INSERT_TAIL</a>(&amp;active_page_head, ap, entries);
<a name="l00277"></a>00277         }
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279     
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (frame)
<a name="l00281"></a>00281         *frame = f;
<a name="l00282"></a>00282     <span class="keywordflow">return</span> result;
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 
<a name="l00294"></a>00294 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00295"></a><a class="code" href="a00028.html#g570ba5ab25cdc4950e1d62ea879fb385">00295</a> <a class="code" href="a00028.html#g570ba5ab25cdc4950e1d62ea879fb385" title="Thread MMU.">thread_mmu</a>(<span class="keywordtype">void</span> *pArg)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297     <a class="code" href="a00001.html" title="Struttura per rappresentare una pagina associata ad un frame.">active_page_t</a> *ap, *ap_temp;
<a name="l00298"></a>00298     <a class="code" href="a00012.html" title="Struttura per la rappresentazione in memoria di un processo.">proc_t</a> *current_proc;
<a name="l00299"></a>00299     <a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame_t</a> *f;
<a name="l00300"></a>00300     <a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a> <a class="code" href="a00011.html" title="Struttura per la rappresentazione di una pagina virtuale.">page</a>;
<a name="l00301"></a>00301     <a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a> offset;
<a name="l00302"></a>00302     <a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a> ws[3];
<a name="l00303"></a>00303     <span class="keywordtype">int</span> result;
<a name="l00304"></a>00304     
<a name="l00305"></a>00305     printf(<span class="stringliteral">"--&gt; Thread MMU avviato\n    [RAM=%d, PAGESIZE=%d, "</span>
<a name="l00306"></a>00306            <span class="stringliteral">"PHYS-FRAMES=%d, TOTAL_READ=%d, PROC=%d]\n"</span>,
<a name="l00307"></a>00307            <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#7bbdf033c0ac1031e3d41e4e4c40a0a9">ram_size</a>, <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#9dd3e47e968a8f6beb5d88c6d1b7ebe9">page_size</a>, <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#a7b13eb6d3954f3874a6670e551c29d4">max_page_count</a>,
<a name="l00308"></a>00308            <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#7deeacf0032d6dfa1aa2a9b9532bef4f">total_access</a>, <a class="code" href="a00015.html#710037465055a75cba7d3b2625f966f8" title="Numero di processi concorrenti.">max_proc</a>);
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     <span class="comment">/*</span>
<a name="l00311"></a>00311 <span class="comment">     *  Fintanto che non venga raggiunto il numero totale di accessi, il</span>
<a name="l00312"></a>00312 <span class="comment">     *  thread resta in attesa di processere nuove richieste.</span>
<a name="l00313"></a>00313 <span class="comment">     */</span>
<a name="l00314"></a>00314     <span class="keywordflow">while</span> (!<a class="code" href="a00017.html#c7cb312ff21e1988a8b6bcd47f7449a5" title="Variabile di controllo per l&amp;#39;MMU.">mmu_should_exit</a>) {
<a name="l00315"></a>00315         pthread_mutex_lock(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00316"></a>00316         <span class="keywordflow">while</span> (<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="a00017.html#361f5c696ea1c92c5f6bcc10579dc71c">DATA_AVAILABLE</a>)
<a name="l00317"></a>00317             pthread_cond_wait(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#2d017047068ee847b500c14427ac4d6b">condition</a>, &amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00318"></a>00318         
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (<a class="code" href="a00017.html#c7cb312ff21e1988a8b6bcd47f7449a5" title="Variabile di controllo per l&amp;#39;MMU.">mmu_should_exit</a>) {
<a name="l00320"></a>00320             pthread_mutex_unlock(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00321"></a>00321             <span class="keywordflow">break</span>;
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323         
<a name="l00324"></a>00324         <span class="comment">/*</span>
<a name="l00325"></a>00325 <span class="comment">         *  La variabile "current" contiene i dati della richiesta da esaminare,</span>
<a name="l00326"></a>00326 <span class="comment">         *  tra cui il PID del processo che ha effettuato la richiesta (utile</span>
<a name="l00327"></a>00327 <span class="comment">         *  per accedere alla sua tabella delle pagine) e l'indirizzo virtuale</span>
<a name="l00328"></a>00328 <span class="comment">         *  dal quale estraggo l'identificativo della pagina virtuale e l'offset.</span>
<a name="l00329"></a>00329 <span class="comment">         */</span>
<a name="l00330"></a>00330         current_proc = <a class="code" href="a00015.html#9399ea5dcc68d7ce40f84bf37593a936" title="Vettore dei processi attivi.">proc_table</a>[<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>];
<a name="l00331"></a>00331         ws[0] = page = <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">virtual_address</a> &gt;&gt; <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#9407343837c7bff10e3fafbcbd4e5e12">offset_bits</a>;
<a name="l00332"></a>00332 <span class="preprocessor">#ifdef VM_DEBUG</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (page &gt; current_proc-&gt;<a class="code" href="a00012.html#d300f63eba5764dcb0ec72bb90bb0199">page_count</a>) {
<a name="l00334"></a>00334             fprintf(stderr, <span class="stringliteral">"PROC = %d, PAGE_COUNT = %d, PAGE = %d, "</span>
<a name="l00335"></a>00335                     <span class="stringliteral">"ADDRESS = %d\n"</span>, <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>, 
<a name="l00336"></a>00336                     current_proc-&gt;<a class="code" href="a00012.html#d300f63eba5764dcb0ec72bb90bb0199">page_count</a>, page, <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">virtual_address</a>);
<a name="l00337"></a>00337             assert(0);
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339 <span class="preprocessor">#endif </span><span class="comment">/* VM_DEBUG */</span>
<a name="l00340"></a>00340         offset = <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">virtual_address</a> &amp; <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#aeff6f121e4b4b87654c3c98ff8afb2a">offset_mask</a>;
<a name="l00341"></a>00341     
<a name="l00342"></a>00342         fprintf(current_proc-&gt;<a class="code" href="a00012.html#b936051f5aaca44c6c3c41dee0d19c36">log_file</a>,
<a name="l00343"></a>00343                 <span class="stringliteral">"\n%s indirizzo virtuale %u [pagina %d - offset %d]\n"</span>,
<a name="l00344"></a>00344                 <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#46d8fecc4efcd342f94ef379799fd7db">rw</a> ? <span class="stringliteral">"Scrittura"</span> : <span class="stringliteral">"Lettura"</span>,
<a name="l00345"></a>00345                 <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">virtual_address</a>, page, offset);
<a name="l00346"></a>00346         
<a name="l00347"></a>00347         
<a name="l00348"></a>00348         result = <a class="code" href="a00028.html#gbdc6ce22565ec4cc97a358429ffa5bd4" title="Algoritmo di rimpiazzo della pagina.">second_chance</a>(<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>, page, 1, &amp;f);
<a name="l00349"></a>00349 <span class="preprocessor">#ifdef VM_DEBUG</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>        assert(f);
<a name="l00351"></a>00351 <span class="preprocessor">#endif </span><span class="comment">/* VM_DEBUG */</span>
<a name="l00352"></a>00352         
<a name="l00353"></a>00353         <span class="keywordflow">if</span> (<a class="code" href="a00017.html#e4cc024f7d0cb7543216fc463ab91af3" title="Indica se la paginazione anticipata risulta attiva.">anticipatory_paging</a>) {
<a name="l00354"></a>00354             ws[1] = (page &gt; 0)?page-1:(<a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a>)-1;
<a name="l00355"></a>00355             ws[2] = (page &lt; (current_proc-&gt;<a class="code" href="a00012.html#d300f63eba5764dcb0ec72bb90bb0199">page_count</a>-1))?page+1:(<a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a>)-1;
<a name="l00356"></a>00356             <span class="keywordflow">if</span> (ws[1] != (<a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a>) -1)
<a name="l00357"></a>00357                 <a class="code" href="a00028.html#gbdc6ce22565ec4cc97a358429ffa5bd4" title="Algoritmo di rimpiazzo della pagina.">second_chance</a>(<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>, ws[1], 0, NULL);
<a name="l00358"></a>00358             <span class="keywordflow">if</span> (ws[2] != (<a class="code" href="a00024.html#c531592bdbc7dfba81524d5eb21f9778" title="Definizione del tipo numero intero non segnato a 16 bit.">uint16_t</a>) -1)
<a name="l00359"></a>00359                 <a class="code" href="a00028.html#gbdc6ce22565ec4cc97a358429ffa5bd4" title="Algoritmo di rimpiazzo della pagina.">second_chance</a>(<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a>, ws[2], 0, NULL); 
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361         
<a name="l00362"></a>00362         current_proc-&gt;<a class="code" href="a00012.html#b30a97b34de52ba50f4a68dd215fe39a">stats</a>.<a class="code" href="a00013.html#88477e9a7dd03e60dc69318c392ff847">mem_accesses</a>++;
<a name="l00363"></a>00363         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#cb9f48647496bd11e112f404238dc138">translated_address</a> = f-&gt;<a class="code" href="a00003.html#11846ffc309e152ba70c778579493427">physical_addr</a> + offset;
<a name="l00364"></a>00364         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="a00017.html#d5bf9f19224fe7d09c85b593d5e25b42">RESULT_AVAILABLE</a>;
<a name="l00365"></a>00365         fprintf(current_proc-&gt;<a class="code" href="a00012.html#b936051f5aaca44c6c3c41dee0d19c36">log_file</a>,
<a name="l00366"></a>00366                 <span class="stringliteral">"[PAGE %s] L'indirizzo virtuale %u corrisponde al fisico %u\n"</span>,
<a name="l00367"></a>00367                 result?<span class="stringliteral">"HIT"</span>:<span class="stringliteral">"FAULT"</span>, <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">virtual_address</a>,
<a name="l00368"></a>00368                 <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#cb9f48647496bd11e112f404238dc138">translated_address</a>);
<a name="l00369"></a>00369         <span class="keywordflow">if</span> (<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#46d8fecc4efcd342f94ef379799fd7db">rw</a>)
<a name="l00370"></a>00370             <a class="code" href="a00018.html#6727db79c42008427edbef4a4899c137" title="Imposta a uno il bit dirty della pagina.">PAGE_SET_DIRTY</a>(current_proc-&gt;<a class="code" href="a00012.html#00862739fa1ee52925b945d4d54983e6">page_table</a>[page]);
<a name="l00371"></a>00371         
<a name="l00372"></a>00372         pthread_mutex_unlock(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00373"></a>00373         pthread_cond_signal(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#2d017047068ee847b500c14427ac4d6b">condition</a>);
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375     <span class="comment">/*</span>
<a name="l00376"></a>00376 <span class="comment">     *  Dealloco la lista delle pagine utilizzate.</span>
<a name="l00377"></a>00377 <span class="comment">     */</span>
<a name="l00378"></a>00378     <a class="code" href="a00021.html#2a85f19896399eecd0ebf91cb8176166">TAILQ_FOREACH_SAFE</a>(ap, &amp;<a class="code" href="a00017.html#16e8bd7a2c1c586be688cd20715372ca">active_page_head</a>, entries, ap_temp) {
<a name="l00379"></a>00379         <a class="code" href="a00021.html#aae87ca18c28066e1a96221e762d1209">TAILQ_REMOVE</a>(&amp;<a class="code" href="a00017.html#16e8bd7a2c1c586be688cd20715372ca">active_page_head</a>, ap, entries);
<a name="l00380"></a>00380         <a class="code" href="a00024.html#26b1ec19cda38557779b21ff0b1a7d65" title="Deallocazione sicura di un blocco di memoria. Viene dapprima effettuato un controllo...">XFREE</a>(ap);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382     printf(<span class="stringliteral">"&lt;-- Thread MMU terminato\n"</span>);
<a name="l00383"></a>00383     pthread_exit(NULL);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 
<a name="l00400"></a><a class="code" href="a00028.html#gf97ffa8a4eade22efcc3545bb3c46d6e">00400</a> pthread_t *<a class="code" href="a00028.html#gf97ffa8a4eade22efcc3545bb3c46d6e" title="Inizializzazione MMU.">mmu_init</a>(<span class="keywordtype">int</span> max_read, <span class="keywordtype">int</span> ram_size, <span class="keywordtype">int</span> page_size)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     pthread_t *tid = <a class="code" href="a00024.html#5bd6c80bbb0fa36b35dddb1c9606e99c" title="Macro per migliorare la leggibilita&amp;#39; dell&amp;#39;operazione di allocazione di blocchi...">XMALLOC</a>(pthread_t, 1);
<a name="l00403"></a>00403     <span class="keywordtype">int</span> i, ret;
<a name="l00404"></a>00404     
<a name="l00405"></a>00405     <a class="code" href="a00017.html#c7cb312ff21e1988a8b6bcd47f7449a5" title="Variabile di controllo per l&amp;#39;MMU.">mmu_should_exit</a> = 0;
<a name="l00406"></a>00406     <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#7deeacf0032d6dfa1aa2a9b9532bef4f">total_access</a> = max_read;
<a name="l00407"></a>00407     <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#259b2896187acb71444706a1878157e4">page_hits</a> = <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#e050b82b994239e7902e82bb0ce27626">page_faults</a> = 0;
<a name="l00408"></a>00408     <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#9dd3e47e968a8f6beb5d88c6d1b7ebe9">page_size</a> = page_size;
<a name="l00409"></a>00409     <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#7bbdf033c0ac1031e3d41e4e4c40a0a9">ram_size</a> = ram_size;
<a name="l00410"></a>00410     <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#a7b13eb6d3954f3874a6670e551c29d4">max_page_count</a> = (<a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#7bbdf033c0ac1031e3d41e4e4c40a0a9">ram_size</a> / <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#9dd3e47e968a8f6beb5d88c6d1b7ebe9">page_size</a>);
<a name="l00411"></a>00411     
<a name="l00412"></a>00412     <span class="comment">/*</span>
<a name="l00413"></a>00413 <span class="comment">     *  Se il rapporto frame/processi risulta troppo basso, non e conveniente</span>
<a name="l00414"></a>00414 <span class="comment">     *  utilizzare la paginazione anticipata.</span>
<a name="l00415"></a>00415 <span class="comment">     */</span>
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (((<span class="keywordtype">float</span>)<a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#a7b13eb6d3954f3874a6670e551c29d4">max_page_count</a>/<a class="code" href="a00015.html#710037465055a75cba7d3b2625f966f8" title="Numero di processi concorrenti.">max_proc</a>) &lt; 3)
<a name="l00417"></a>00417         <a class="code" href="a00017.html#e4cc024f7d0cb7543216fc463ab91af3" title="Indica se la paginazione anticipata risulta attiva.">anticipatory_paging</a> = 0;
<a name="l00418"></a>00418     
<a name="l00419"></a>00419     <span class="comment">/*</span>
<a name="l00420"></a>00420 <span class="comment">     *  Inizializza la lista dei frame usati e liberi e delle pagine residenti</span>
<a name="l00421"></a>00421 <span class="comment">     *  in memoria (ovvero associate ad un frame.</span>
<a name="l00422"></a>00422 <span class="comment">     */</span>
<a name="l00423"></a>00423     <a class="code" href="a00021.html#3b508a1c06ded6b4ce4b1feea7643c28">STAILQ_INIT</a>(&amp;<a class="code" href="a00017.html#004c64e9f470ff8317d439639f332c6e" title="Lista dei frame inutilizzati (puntatore al primo elemento).">free_frames_head</a>);
<a name="l00424"></a>00424     <a class="code" href="a00021.html#3b508a1c06ded6b4ce4b1feea7643c28">STAILQ_INIT</a>(&amp;<a class="code" href="a00017.html#a7a68db730586e1b608240a228d4f707" title="Lista dei frame utilizzati (puntatore al primo elemento).">used_frames_head</a>);
<a name="l00425"></a>00425     <a class="code" href="a00021.html#449d224023780e46253b83b61e0a50a9">TAILQ_INIT</a>(&amp;<a class="code" href="a00017.html#16e8bd7a2c1c586be688cd20715372ca">active_page_head</a>);
<a name="l00426"></a>00426     
<a name="l00427"></a>00427     <span class="comment">/*</span>
<a name="l00428"></a>00428 <span class="comment">     *  Suddivide la memoria in frame e li inserisce nella lista dei</span>
<a name="l00429"></a>00429 <span class="comment">     *  frame liberi. Crea infine il thread che emula l'MMU.</span>
<a name="l00430"></a>00430 <span class="comment">     */</span>
<a name="l00431"></a>00431     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#a7b13eb6d3954f3874a6670e551c29d4">max_page_count</a>; i++) {
<a name="l00432"></a>00432         <a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame_t</a> *f = <a class="code" href="a00024.html#5bd6c80bbb0fa36b35dddb1c9606e99c" title="Macro per migliorare la leggibilita&amp;#39; dell&amp;#39;operazione di allocazione di blocchi...">XMALLOC</a>(<a class="code" href="a00003.html" title="Struttura per la rappresentazione di un frame di memoria.">frame_t</a>, 1);
<a name="l00433"></a>00433         f-&gt;<a class="code" href="a00003.html#4fc3a0c58dfbd1e68224521185cb9384">id</a> = i;
<a name="l00434"></a>00434         f-&gt;<a class="code" href="a00003.html#11846ffc309e152ba70c778579493427">physical_addr</a> = i * <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#9dd3e47e968a8f6beb5d88c6d1b7ebe9">page_size</a>;
<a name="l00435"></a>00435         f-&gt;<a class="code" href="a00003.html#4a32eceb12f1d4b807a007461348ec09">valid</a> = 0;
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (<a class="code" href="a00021.html#8427c8f43d09d73062cf6b37f303aff5">STAILQ_EMPTY</a>(&amp;<a class="code" href="a00017.html#004c64e9f470ff8317d439639f332c6e" title="Lista dei frame inutilizzati (puntatore al primo elemento).">free_frames_head</a>))
<a name="l00437"></a>00437             <a class="code" href="a00021.html#ad3b1fb87b675bae75334acd958b57dc">STAILQ_INSERT_HEAD</a>(&amp;<a class="code" href="a00017.html#004c64e9f470ff8317d439639f332c6e" title="Lista dei frame inutilizzati (puntatore al primo elemento).">free_frames_head</a>, f, entries);
<a name="l00438"></a>00438         <span class="keywordflow">else</span>
<a name="l00439"></a>00439             <a class="code" href="a00021.html#7bc9a31418b55c5698be3e54e10bb484">STAILQ_INSERT_TAIL</a>(&amp;<a class="code" href="a00017.html#004c64e9f470ff8317d439639f332c6e" title="Lista dei frame inutilizzati (puntatore al primo elemento).">free_frames_head</a>, f, entries);
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     ret = pthread_create(tid, NULL, &amp;<a class="code" href="a00028.html#g570ba5ab25cdc4950e1d62ea879fb385" title="Thread MMU.">thread_mmu</a>, NULL);
<a name="l00442"></a>00442     
<a name="l00443"></a>00443     <span class="keywordflow">return</span> (ret == 0) ? tid : NULL;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 
<a name="l00460"></a><a class="code" href="a00028.html#gc23a1ee8fe6271110099f07ca81163ed">00460</a> <a class="code" href="a00024.html#6593e0188f8e2719be63f87d53734582" title="Definizione del tipo numero intero non segnato a 32 bit.">uint32_t</a> <a class="code" href="a00028.html#gc23a1ee8fe6271110099f07ca81163ed" title="Funzione per la lettura/scrittura di una zona di memoria.">memory_access</a>(<span class="keywordtype">int</span> procnum, <a class="code" href="a00024.html#6593e0188f8e2719be63f87d53734582" title="Definizione del tipo numero intero non segnato a 32 bit.">uint32_t</a> address, <span class="keywordtype">int</span> rw)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462     <span class="keyword">static</span> <span class="keywordtype">int</span> signaled = 0;
<a name="l00463"></a>00463     <a class="code" href="a00024.html#6593e0188f8e2719be63f87d53734582" title="Definizione del tipo numero intero non segnato a 32 bit.">uint32_t</a> result = (<a class="code" href="a00024.html#6593e0188f8e2719be63f87d53734582" title="Definizione del tipo numero intero non segnato a 32 bit.">uint32_t</a>) -1;
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     <span class="comment">/*</span>
<a name="l00466"></a>00466 <span class="comment">     *  Blocco il mutex "mem_read_lock" per garantire la mutua esclusione</span>
<a name="l00467"></a>00467 <span class="comment">     *  tra due processi concorrenti che tentano l'accesso alla MMU.</span>
<a name="l00468"></a>00468 <span class="comment">     */</span>
<a name="l00469"></a>00469     pthread_mutex_lock(&amp;<a class="code" href="a00017.html#66b87664ca0ad1edc381b14015d44eb5" title="Mutex per la mutua esclusione della chiamata a memory_access.">mem_read_lock</a>);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="keywordflow">if</span> (<a class="code" href="a00018.html#ad24872b31f6b55a0eca0506ab5765f9" title="Restituisce il numero di richieste effettuate all&amp;#39;MMU.">NUM_OF_REQUESTS</a>() &lt; <a class="code" href="a00018.html#da2557f9d82bb48f501d53cb4c2d9a0e">mmu</a>.<a class="code" href="a00008.html#7deeacf0032d6dfa1aa2a9b9532bef4f">total_access</a>) {     
<a name="l00472"></a>00472         <span class="comment">/*</span>
<a name="l00473"></a>00473 <span class="comment">         *  Inserisco i dettagli della richiesta in una struttura condivisa</span>
<a name="l00474"></a>00474 <span class="comment">         *  tra questa funzione ed il thread, protetta dal mutex current.lock.</span>
<a name="l00475"></a>00475 <span class="comment">         */</span>
<a name="l00476"></a>00476         pthread_mutex_lock(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00477"></a>00477         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0ef81d88e57e6e5438f9d4e39d4985ca">procnum</a> = procnum;
<a name="l00478"></a>00478         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#656ac49233b57f25193e6e7c70054f17">virtual_address</a> = address;
<a name="l00479"></a>00479         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#cb9f48647496bd11e112f404238dc138">translated_address</a> = 0;
<a name="l00480"></a>00480         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#46d8fecc4efcd342f94ef379799fd7db">rw</a> = rw;
<a name="l00481"></a>00481         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="a00017.html#361f5c696ea1c92c5f6bcc10579dc71c">DATA_AVAILABLE</a>;
<a name="l00482"></a>00482         pthread_mutex_unlock(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00483"></a>00483         
<a name="l00484"></a>00484         <span class="comment">/*</span>
<a name="l00485"></a>00485 <span class="comment">         * Comunico al thread MMU che e' disponibile una richiesta</span>
<a name="l00486"></a>00486 <span class="comment">         */</span>
<a name="l00487"></a>00487         pthread_cond_signal(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#2d017047068ee847b500c14427ac4d6b">condition</a>);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <span class="comment">/*</span>
<a name="l00490"></a>00490 <span class="comment">         *  Attendo che la richiesta venga espletata dalla MMU: al termine</span>
<a name="l00491"></a>00491 <span class="comment">         *  il risultato verra' restituito al processo chiamante, il mutex</span>
<a name="l00492"></a>00492 <span class="comment">         *  rilasciato e l'MMU sara' pronta per una successiva richiesta.</span>
<a name="l00493"></a>00493 <span class="comment">         */</span>
<a name="l00494"></a>00494         pthread_mutex_lock(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00495"></a>00495         <span class="keywordflow">while</span> (<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="a00017.html#d5bf9f19224fe7d09c85b593d5e25b42">RESULT_AVAILABLE</a>)
<a name="l00496"></a>00496             pthread_cond_wait(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#2d017047068ee847b500c14427ac4d6b">condition</a>, &amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00497"></a>00497         result = <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#cb9f48647496bd11e112f404238dc138">translated_address</a>;
<a name="l00498"></a>00498         <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="a00017.html#2b7cf2a3641be7b89138615764d60ba3">EMPTY</a>;
<a name="l00499"></a>00499         pthread_mutex_unlock(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#0abaf4b5d42c4e5d19190035fade3599">lock</a>);
<a name="l00500"></a>00500         
<a name="l00501"></a>00501         <span class="keywordflow">if</span> (<a class="code" href="a00017.html#c3e1795766a80ec63b157951b4b9a7d4" title="Livello di debug.">debug</a>)
<a name="l00502"></a>00502             <a class="code" href="a00029.html#g2b52a774545c4534786424f7d551d32c" title="Stampa lo stato delle pagine di un processo.">process_info</a>(procnum);
<a name="l00503"></a>00503     } <span class="keywordflow">else</span> {
<a name="l00504"></a>00504         <span class="comment">/*</span>
<a name="l00505"></a>00505 <span class="comment">         *  E' stato raggiunto il numero massimo di accessi alla memoria:</span>
<a name="l00506"></a>00506 <span class="comment">         *  comunico al thread MMU e del dispositivo I/O di uscire; </span>
<a name="l00507"></a>00507 <span class="comment">         *  restituisco un codice d'errore (-1) al processo chiamante,</span>
<a name="l00508"></a>00508 <span class="comment">         *  perche' questo termini la propria esecuzione.</span>
<a name="l00509"></a>00509 <span class="comment">         */</span>
<a name="l00510"></a>00510         <span class="keywordflow">if</span> (!signaled) {
<a name="l00511"></a>00511             <a class="code" href="a00027.html#gbc58cac7b3c0bd4162719dd9f846a6ae" title="Determina l&amp;#39;uscita del thread di I/O.">tell_io_device_to_exit</a>();
<a name="l00512"></a>00512             <a class="code" href="a00017.html#c7cb312ff21e1988a8b6bcd47f7449a5" title="Variabile di controllo per l&amp;#39;MMU.">mmu_should_exit</a> = 1;
<a name="l00513"></a>00513             <a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#6e27f49150e9a14580fb313cc2777e00">status</a> = <a class="code" href="a00017.html#361f5c696ea1c92c5f6bcc10579dc71c">DATA_AVAILABLE</a>;
<a name="l00514"></a>00514             pthread_cond_signal(&amp;<a class="code" href="a00017.html#7520871bbfeb026c594b6b8d092fade7" title="Istanza della struttura mmu_shared_data.">current</a>.<a class="code" href="a00009.html#2d017047068ee847b500c14427ac4d6b">condition</a>);
<a name="l00515"></a>00515             signaled = 1;
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     
<a name="l00519"></a>00519     pthread_mutex_unlock(&amp;<a class="code" href="a00017.html#66b87664ca0ad1edc381b14015d44eb5" title="Mutex per la mutua esclusione della chiamata a memory_access.">mem_read_lock</a>);
<a name="l00520"></a>00520     
<a name="l00521"></a>00521     <span class="keywordflow">return</span> result;
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
</pre></div></div>
<table border="0" width="100%" style="border-top:1px solid black;">
	<tr><td align="center"><img src="logo_uniurbdotit.jpg"></td></tr>
	<tr><td align="center"><b>Universit degli studi di Urbino "Carlo Bo"</b></td></tr>
</table>	
